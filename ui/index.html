<html>
  <head>
    <script src="https://unpkg.com/@urbit/http-api"></script>
    <script src="/session.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@2.1.0/build/pure-min.css" integrity="sha384-yHIFVG6ClnONEA5yB5DJXfW2/KC173DIQrYoZMEtBvGzmf0PKiGyNEqe9N6BNDBH" crossorigin="anonymous">
    <style type="text/css">
      .navbar {
        background: #666;
      }
      .navbar .plug-menu-link {
        color: #fff;
      }
      .navbar .plug-menu-link:hover {
        background: #444;
      }
      .nav-right {
        /*text-align: right;*/
      }
      .pad-bottom {
        margin: 0 0 12px 0;
      }
      /* image input */
      .plug-image-input {
        position: relative;
        width: 150px;
      }
      .plug-image-input-button {
        position: absolute;
        right: 8px;
        bottom: 8px;
      }
      /* Product Table Styles */
      .checkbox-field {
        text-align: center;
      }
      /* Alt Button Styles */
      .pure-button.button-danger {
        background-color: rgb(202, 60, 60);
        color: #fff;
      }
      .pure-button.button-secondary {
        background-color: background: rgb(66, 184, 221);
        color: #fff;
      }
      .pure-button.button-warning {
        background-color: rgb(223, 117, 20);
        color: #fff;
      }
      /* Product card */
      .product-card {
        position: relative;
        width: 150px;
        height: 200px;
        background-size: cover;
        /* positioning in grid */
        float: left;
        margin-right: 12px;
      }
      .product-title {
        position: absolute;
        margin: 0;
        background: rgba(256,256,256,0.4);
        top: 0px;
        left: 0px;
        right: 0px;
        padding-top: 4px;
        padding-left: 4px;
      }
      .view-product-button {
        position: absolute;
        margin: 0;
        bottom: 8px;
        right: 8px;
      }
      /* store preview header */
      .preview-header {
        margin-top: 48px;
        display: flex;
      }
      .store-avatar {
        width: 150px;
        height: 150px;
        border-radius: 75px;
        overflow: hidden;
      }
      .preview-header-content {
        width: calc(100% - 160px);
        margin-left: 12px;
      }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <div id="app"></div>
  </body>
  <script>
    function App () {
      const agent = PlugAgent()
      return {
        agent,
        currentStore: null,
        // UI Components (View)
        // Pages
        Dashboard () {
          return `
            <div>
              ${this.Header()}
              ${this.PageContent(`
                <div class="page-content">
                  <h2>Welcome to Plug</h2>
                  ${this.PreviewButton()}
                  ${this.ProductTable()}
                  ${this.OrdersTable()}
                </div>
              `)}
            </div>
            `
        },
        ProductsPage () {
          return `
            <div>
              ${this.Header()}
              ${this.PageContent(this.ProductTable())}
            </div>
            `
        },
        EditProductPage (product) {
          return `
            <div>
              ${this.Header()}
              ${this.PageContent(this.ProductForm(product, 'Edit Product', this.SaveProductButton(product.id)))}
            </div>
            `
        },
        CreateProductPage () {
          return `
            <div>
              ${this.Header()}
              ${this.PageContent(this.ProductForm({}, 'Create Product', this.CreateProductButton()))}
            </div>
            `
        },
        OrdersPage () {
          return `
            <div>
              ${this.Header()}
              ${this.PageContent(this.OrdersTable())}
            </div>
          `
        },
        StoreSettingsPage () {
          return `
            <div>
              ${this.Header()}
              ${this.PageContent(`
                <div class="page-content">
                  <h2>Store Settings</h2>
                  ${this.StoreForm('Edit Store', this.SaveStoreButton(), this.currentStore.store, true, true)}
                </div>
              `)}
            </div>
          `
        },
        CreateStorePage () {
          return `
            <div>
              ${this.PageContent(this.StoreForm('Create A New Store', this.CreateStoreButton(), store={},  deleteButton=false))}
            </div>
          `
        },
        NewStorePage () {
          return `
            <div>
              ${this.PageContent(this.StoreForm('Welcome to Plug! - What Would You like to call your first store?', this.CreateStoreButton(), store={},  deleteButton=false))}
            </div>
          `
        },
        StorePreviewPage () {
          const { store } = this.currentStore
          const catalog = this.agent.catalog
          return `
            <div>
              ${this.PageContent(`
                <div class="preview-header">
                  ${store.avatar ? `
                    <div class="store-avatar">
                      <img src="${store.avatar}"/>
                    </div>
                  ` : ''}
                  <div class="preview-header-content">
                    <h1>${store.title}</h2>
                    ${store.description ? `
                      <div class="store-about-us">
                        <p>${store.description}</p>
                      </div>
                    ` : `
                      <div class="store-about-us">
                        <p>Remember to add a description to your store. it will Show up here</p>
                      </div>
                    `}
                  </div>
                </div>
                <h2>Products</h2>
                <div class="product-grid">
                  <div class="product-card" style="background-image: url('https://random.imagecdn.app/300/500')">
                    <h4 class="product-title">Title</h4>
                    <button class="pure-button view-product-button">View</img>
                  </div>
                  <div class="product-card" style="background-image: url('https://random.imagecdn.app/302/500')">
                    <h4 class="product-title">Title</h4>
                    <button class="pure-button view-product-button">View</img>
                  </div>
                  <div class="product-card" style="background-image: url('https://random.imagecdn.app/301/500')">
                    <h4 class="product-title">Title</h4>
                    <button class="pure-button view-product-button">View</img>
                  </div>
                </div>
              `)}
            </div>
          `
        },
        // header Components
        Header () {
          return `
            <div class="pure-g">
              <div class="pure-u-2-3">
                <div class="navbar nav-left pure-menu pure-menu-horizontal">
                  <a href="#" onclick="window.app.navigate('dashboard')" class="pure-menu-heading pure-menu-link plug-menu-link">Plug</a>
                  <ul class="pure-menu-list">
                    <li class="pure-menu-item">
                      <a href="#" onclick="window.app.navigate('products')" class="pure-menu-link plug-menu-link">Products</a>
                    </li>
                    <li class="pure-menu-item">
                      <a href="#" onclick="window.app.navigate('orders')" class="pure-menu-link plug-menu-link">Orders</a>
                    </li>
                    <li class="pure-menu-item">
                      <a href="#" onclick="window.app.navigate('store-settings')" class="pure-menu-link plug-menu-link">Store</a>
                    </li>
                  </ul>
                </div>
              </div>
              <div class="pure-u-1-3">
                ${this.StoresDropDown()}
              </div>
            </div>
          `
        },
        StoresDropDown () {
          return `
            <div class="navbar nav-right pure-menu pure-menu-horizontal">
              <ul class="pure-menu-list">
                <li class="pure-menu-item pure-menu-has-children pure-menu-allow-hover">
                  <a href="#" class="pure-menu-link plug-menu-link">${this.currentStore.store.title}</a>
                  <ul class="pure-menu-children">
                    ${this.agent.stores.reduce((html, store) => html += this.StoreDropDownOption(store), '')}
                    <li class="pure-menu-item">
                      <a onclick="window.app.navigate('create-store')"href="#" class="pure-menu-link">+ Create Store</a>
                    </li>
                  </ul>
                </li>
              </ul>
            </div>
          `
        },
        StoreDropDownOption (store) {
          return `
            <li class="pure-menu-item">
              <a onclick="window.app.changeStore(${store.store.id})"href="#" class="pure-menu-link">${store.store.title}</a>
            </li>
          `
        },
        // Product List Page Components
        ProductTable () {
          return `
            <div><h2>Products</h2></div>
            <button class="pure-button pad-bottom" onclick="window.app.navigate('create-product')">Add New</button>
            <div>
              <table class="pure-table pure-table-bordered">
                <thead>
                  <tr>
                      <th>${this.ProductTableDropDown()}</th>
                      <th>ID</th>
                      <th>Image</th>
                      <th>Name</th>
                      <th>Price</th>
                      <th>Manage</th>
                  </tr>
                </thead>
                <tbody>
                  ${this.agent.catalog.reduce((html, product) => html + this.ProductRow(product.product), '')}
                </tbody>
              </table>            
            </div>
          `
        },
        ProductRow (product) {
          return `
            <tr>
              <td class="checkbox-field"><input type="checkbox" value="" /></td>
              <td>${product.id}</td>
              <td><img width="50px" src="${product.images[0]}"></img></td>
              <td>${product.title}</td>
              <td>${this.price(product.price)} </td>
              <td>
                <button onclick="window.app.navigate('product', { 'product': ${this.pass(product)}})" class="pure-button">Edit</button>
                <button class="pure-button" onclick="window.app.deleteProduct(${product.id})">Delete</button>
              </td>
            </tr>
          `
        },
        ProductTableDropDown () {
          return `
            <div class="pure-menu pure-menu-vertical">
              <ul class="pure-menu-list">
                <li class="pure-menu-item pure-menu-allow-hover">
                  <a href="#" class="pure-menu-link plug-menu-link">&#9776;</a>
                  <ul class="pure-menu-children">
                    <li class="pure-menu-item">
                      <a onclick="window.app.selectAll()" href="#" class="pure-menu-link">
                        Select All
                      </a>
                      <a onclick="window.app.deselectAll()" href="#" class="pure-menu-link">
                        Deselect All
                      </a>
                      <a onclick="window.app.removeCheckedProducts()" href="#" class="pure-menu-link">
                        Delete Selected
                      </a>
                    </li>
                  </ul>
                </li>
              </ul>
            </div>
          `
        },
        // Create/Edit Product Components
        ProductForm (product={}, title, button) {
          return `
            <form class="pure-form pure-form-stacked">
              <fieldset>
                <legend>${title}</legend>
                <div class="pure-control-group">
                  <label for="product-title">Title</label>
                  <input ${product.title ? `value="${product.title}"` : ''} autofocus type="text" id="product-title" placeholder="My Cool Widget" />
                </div>
                <label>Images</label>
                <div id="product-images">
                  ${product.images ? product.images.reduce((html, image) => html + this.ImageInput(image), ''): ''}
                </div>
                <div class="pure-control-group">
                  <label for="product-image-url">Image Link</label>
                  <input type="text" id="product-image-url" placeholder="https://mysite.com/someimage.jpg" />
                </div>
                <button type="button" onclick="window.app.addProductImage()" class="pure-button">
                  Add Image
                </button>
                <div class="pure-control-group">
                  <label for="product-description">Description</label>
                  <textarea id="product-description" placeholder="Write about all it's cool features here">${product.description ? product.description : ''}</textarea>
                </div>
                <div class="pure-control-group">
                  <label for="product-price">Price</label>
                  <input ${product.price ? `value="${product.price}"` : ''} type="text" id="product-price" placeholder="$99.99" />
                </div>
                ${button}
              </fieldset>
            </form>
          `
        },
        ImageInput (image) {
          return `
            <div class="plug-image-input">
              <img class="plug-image-input-image" width="150px" src="${image}"></img>
              <button class="plug-image-input-button" type="button" onclick="window.app.removeImageInput(this)">Remove</button>
            </div>
          `
        },
        CreateProductButton () {
          return `
            <button type="button" onclick="window.app.createProduct()" class="pure-button pure-button-primary">Create</button>
          `
        },
        SaveProductButton (id) {
          return `
            <button type="button" onclick="window.app.updateProduct(${id})" class="pure-button pure-button-primary">Save</button>
          `
        },
        // Store (Settings) Components
        StoreForm (title, button, store={}, deleteButton=false, details=false) {
          return `
            <form class="pure-form pure-form-stacked">
              <fieldset>
                <legend>${title}</legend>
                <div class="pure-control-group">
                  <label for="store-title">Title</label>
                  <input ${store.title ? `value="${store.title}"` : ''} autofocus type="text" id="store-title" placeholder="My Awesome Side Hustle" />
                </div>
                ${details ? `
                  <label>Brand Avatar</label>
                  <div id="store-image">
                    ${store.avatar ?  this.ImageInput(store.avatar) : ''}
                  </div>
                  <div class="pure-control-group">
                    <input type="text" id="store-image-url" placeholder="https://mysite.com/someimage.jpg" />
                  </div>
                  <button type="button" onclick="window.app.addStoreImage()" class="pure-button">
                    Upload Image
                  </button>
                  <div class="pure-control-group">
                    <label for="store-description">About Us</label>
                    <textarea id="store-description" placeholder="What do you want to tell customers on your main page?">${store.description ? store.description : ''}</textarea>
                  </div>
                ` :''}
                ${button}
                ${deleteButton ? this.DeleteStoreButton() : ''}
              </fieldset>
            </form>          `
        },
        DeleteStoreButton () {
          return `
            <button class="pure-button button-danger" onclick="window.app.deleteStore()">
              Delete Store
            </button>
          `
        },
        SaveStoreButton () {
          return `
            <button class="pure-button pure-button-primary" onclick="window.app.saveStore()">
              Save
            </button>
          `
        },
        CreateStoreButton () {
          return `
            <button class="pure-button pure-button-primary" onclick="window.app.createStore()">
              Create Store
            </button>
          `
        },
        // Orders Components
        OrdersTable () {
          return `
            <div>
              <h2>Orders</h2>
              <h4>Coming Soon!</h4>
            </div>
          `
        },
        // Generic Components
        PreviewButton () {
          return `
            <button class="pure-button" onclick="window.app.navigate('store-preview')">
              Preview Store
            </button>
          `
        },
        PageContent (content) {
          return `
            <div class="pure-g">
              <div class="pure-u-1-12"></div>
              <div class="pure-u-5-6">${content}</div>
              <div class="pure-u-1-12"></div>
            </div>
          `
        },
        // Controller — Lifecycle, Presentation, Interactions
        // Lifecycle
        onLoad: async function () {
          await this.agent.fetchAllStores()
          if (this.agent.stores.length < 1) {
            this.navigate('new-store')
          } else {
            this.currentStore = this.agent.stores[0]
            await this.agent.fetchAllProducts(this.currentStore.id)
            this.navigate('dashboard')
          }
        },
        // Router
        navigate (page, params={}) {
          let pageHTML
          switch (page) {
            case "dashboard":
              pageHTML = this.Dashboard()
              break;
            case "products":
              pageHTML = this.ProductsPage()
              break;
            case "create-product":
              pageHTML = this.CreateProductPage()
              break;
            case "product":
              pageHTML = this.EditProductPage(params.product)
              break;
            case "orders":
              pageHTML = this.OrdersPage()
              break;
            case "store-settings":
              pageHTML = this.StoreSettingsPage()
              break;
            case "create-store":
              pageHTML = this.CreateStorePage()
              break;
            case "new-store":
              pageHTML = this.NewStorePage()
              break;
            case "store-preview":
              pageHTML = this.StorePreviewPage()
              break;
          }
          document.getElementById("app").innerHTML = pageHTML
        },
        // 
        // Interactions
        // 
        async createStore () {
          const title = document.getElementById('store-title').value
          await this.agent.createStore(title)
          this.currentStore = this.agent.stores.filter(store => store.store.title == title)[0]
          this.changeStore(this.currentStore.id)
          this.navigate('dashboard')
        },
        async saveStore () {
          const title = document.getElementById('store-title').value
          const description = document.getElementById('store-description').value
          const avatar = document.querySelector('#store-image img').src
          await this.agent.updateStore(this.currentStore.id, title, description, avatar)
          this.changeStore(this.currentStore.id)
        },
        async deleteStore () {
          await this.agent.deleteStore(this.currentStore.id)
          if (this.agent.stores.length == 0) {
            this.navigate('new-store')
          } else {
            this.currentStore = this.agent.stores[0]
            this.navigate('dashboard')
          }
        },
        async createProduct () {
          const { title, description, price, images } = this.validateProduct()
          await this.agent.createProduct(this.currentStore.id, { title, description, images, price})
          this.navigate('products')
        },
        async updateProduct (id) {
          const { title, description, price, images } = this.validateProduct()
          await this.agent.updateProduct(this.currentStore.id, { id, title, description, images, price})
          this.navigate('products')
        },
        async deleteProduct (id) {
          await this.agent.deleteProduct(this.currentStore.id, id)
          this.navigate('products')
        },
        async changeStore (id) {
          store = this.agent.stores.filter(s => s.id == id)[0]
          this.currentStore = store
          await this.agent.fetchAllProducts(this.currentStore.id)
          this.navigate('dashboard')
        },
        // image input interactions
        addProductImage () {
          const url = document.getElementById("product-image-url").value
          const list = document.getElementById("product-images")
          list.innerHTML = list.innerHTML + this.ImageInput(url)
        },
        addStoreImage () {
          const url = document.getElementById("store-image-url").value
          const div = document.getElementById("store-image")
          div.innerHTML = this.ImageInput(url)
        },
        removeImageInput (el) {
          el.parentElement.remove();
        },
        // table dropdown interactions
        selectAll() {
          document.querySelectorAll('input[type="checkbox"]').forEach(el => el.checked = true)
        },
        deselectAll() {
          document.querySelectorAll('input[type="checkbox"]').forEach(el => el.checked = false)
        },
        removeCheckedProducts () {
          document.querySelectorAll('input[type="checkbox"]').forEach(el => {
            if (el.checked) {
              const productId = Number(el.parentElement.nextElementSibling.innerHTML)
              this.deleteProduct(productId)
            }
          })
        },
        // async openLog () {
        //   this.isLogOpen = true
        //   this.navigate('product-detail', { id: this.id })
        // },
        // async closeLog () {
        //   this.isLogOpen = false
        //   this.navigate('product-detail', { id: this.id })
        // }
        // UI Utils
        price (cents) {
          const ones = cents % 10
          return ones > 0 ? '$' + (cents/100) : '$' + (cents/100) + '0'
        },
        pass (item) {
          return JSON
            .stringify(item)
            .replaceAll(`"`,`'`)
        },
        validateProduct () {
          const title = document.getElementById("product-title").value
          const description = document.getElementById("product-description").value
          const price = Number(
            document.getElementById("product-price").value
            .replaceAll(',', '')
            .replaceAll('.', '')
            .replaceAll('$', '')
          )
          const images = []
          document.querySelectorAll('#product-images img').forEach(el => images.push(el.src))
          if (!title) {
            alert('Invalid Title')
            return
          }
          if (!description) {
            alert('Invalid Description')
            return
          }
          if (!price) {
            alert('Invalid Price')
            return
          }
          return { title, description, price, images }
        }
      }
    }

    // Services (Model)
    function PlugAgent () {
      const _mock = true
      const api = _mock ? {} : new UrbitHttpApi.Urbit("")
      api.ship = window.ship;
      return {
        _api:api,
        _scry: async function (path) {
          return this._api.scry({ app: "plug", path })
        },
        _poke: async function (name, payload) {
          return this._api.poke({
            app: "plug",
            mark: "plug-action",
            json: { [name]: payload },
            onError: ()=> alert(`PlugAgent: ${name} action rejected`)
          })
        },
        _mock,
        stores: [],
        catalog: [], //todo: replace with subprop on stores
        lastStoreId: null,
        createStore: async function (title) {
          if (this._mock) {
            const id = this.stores.reduce((maxId, store) => maxId > store.id ? maxId : store.id, 0) + 1
            this.stores.push({ id, store: {
              id,
              title,
            }})
          } else {
            await this._poke('create-store', { title })
            if (this.stores.length < 1) {
              await this.fetchAllStores()
              this.lastStoreId = this.stores[0].id
            }
            await this.refreshState()
          }
        },
        updateStore: async function (id, title, description, avatar) {
          if (this._mock) {            
            const store = { id, store: {
              id,
              title,
              description,
              avatar,
            }}
            this.stores = this.stores.filter(store => store.id != id)
            this.stores.push(store)
            this.currentStore = store
          } else {
            await this._poke('update-store', { id, title, description, avatar })
            await this.refreshState()
          }
        },
        deleteStore: async function (id) {
          if (this._mock) {
            this.stores = this.stores.filter(store => store.id != id)
          } else {
            await this._poke('delete-store', { id })
            await this.fetchAllStores()
            if (this.stores.length >= 1) {
              this.lastStoreId = this.stores[0].id
              await this.refreshState()
            }
          }
        },
        createProduct: async function (storeId, { title, description, images, price }) {
          if (this._mock) {
            const id = this.catalog.reduce((maxId, store) => maxId > store.id ? maxId : store.id, 0) + 1
            this.catalog.push({ id, product: { id, title, description, images, price }})
          } else {
            await this._poke('create-product', { 'store-id': storeId, title, description, images, price })
            await this.refreshState()    
          }
        },
        updateProduct: async function (storeId, { id, title, description, images, price }) {
          if (this._mock) {
            this.catalog = this.catalog.filter(item => item.id != id)
            this.catalog.push({ id, product: { id, title, description, images, price }})
          } else {
            await this._poke('update-product', { 'store-id': storeId, 'product-id': id, title, description, images, price })
            await this.refreshState()    
          }
        },
        deleteProduct: async function (storeId, productId) {
          if (this._mock) {
            this.catalog = this.catalog.filter(item => item.id != productId)
          } else {
            await this._poke('delete-product', { 'store-id': storeId, 'product-id': productId })
            await this.refreshState()    
          }
        },
        fetchAllProducts: async function (storeId) {
          this.lastStoreId = storeId
          if(this._mock) {
            this.catalog = [
              {
                "product": {
                  "title": "MrCool 12k btu",
                  "images": ["https://random.imagecdn.app/150/150"],
                  "description": "An AC unit with 12k btu cooling power",
                  "id": 1,
                  "price": 69990
                },
                "id": 1
              },{
                "product": {
                  "title": "MrCool 18k btu",
                  "images": ["https://random.imagecdn.app/150/151"],
                  "description": "An AC unit with 18k btu cooling power",
                  "id": 2,
                  "price": 79995
                },
                "id": 2
              }
            ]
          } else {
            const catalog = await this._scry(`/stores/${storeId}/products/all`)
            this.catalog = catalog
          }
          console.log(JSON.stringify(this.catalog))
        },
        fetchAllStores: async function () {
          if(this._mock) {
            this.stores = [
              { "store":{ 
                "title":"Default Store",
                "avatar": "https://random.imagecdn.app/150/151",
                "id": 1,
                "description": "Lorem Ipsum Dolor Sit Amet. Lorem Ipsum Dolor Sit Amet. Lorem Ipsum Dolor Sit Amet. Lorem Ipsum Dolor Sit Amet. Lorem Ipsum Dolor Sit Amet. Lorem Ipsum Dolor Sit Amet."
              }, "id": 1 },
              { "store":{ "title":"My Side Hsutle", "avatar": "https://random.imagecdn.app/150/151", "id": 2 },"id": 2},
            ]
          } else {
            const stores = await this._scry('/stores')
            this.stores = stores
          }
          console.log(JSON.stringify(this.stores))
        },
        refreshState: async function () {
          await this.fetchAllProducts(this.lastStoreId)
          await this.fetchAllStores()    
        }
      }
    }

    async function main () {
      setTimeout(() => {
        window.app = App()
        app.onLoad()
      }, 1000)
    }
    main()
  </script>
</html>