<html>
  <head>
    <script src="https://unpkg.com/@urbit/http-api"></script>
    <script src="/session.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@2.1.0/build/pure-min.css" integrity="sha384-yHIFVG6ClnONEA5yB5DJXfW2/KC173DIQrYoZMEtBvGzmf0PKiGyNEqe9N6BNDBH" crossorigin="anonymous">
    <style type="text/css">
      .navbar {
        background: #666;
      }
      .navbar .plug-menu-link {
        color: #fff;
      }
      .navbar .plug-menu-link:hover {
        background: #444;
      }
      .nav-right {
        /*text-align: right;*/
      }
      .pad-bottom {
        margin: 0 0 12px 0;
      }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <div id="app"></div>
  </body>
  <script>
    function App () {
      const agent = PlugAgent()
      return {
        agent,
        currentStore: null,
        // UI Components (View)
        // Pages
        Dashboard () {
          return `
            <div>
              ${this.Header()}
              ${this.PageContent(`
                <div class="page-content">
                  <h2>Welcome to Plug</h2>
                  ${this.ProductTable()}
                  ${this.OrdersTable()}
                </div>
              `)}
            </div>
            `
        },
        ProductsPage () {
          return `
            <div>
              ${this.Header()}
              ${this.PageContent(this.ProductTable())}
            </div>
            `
        },
        EditProductPage (product) {
          return `
            <div>
              ${this.Header()}
              ${this.PageContent(this.ProductForm(product, 'Edit Product', this.SaveProductButton(product.id)))}
            </div>
            `
        },
        CreateProductPage () {
          return `
            <div>
              ${this.Header()}
              ${this.PageContent(this.ProductForm({}, 'Create Product', this.CreateProductButton()))}
            </div>
            `
        },
        OrdersPage () {
          return `
            <div>
              ${this.Header()}
              ${this.PageContent(this.OrdersTable())}
            </div>
          `
        },
        StorePage () {
          return `
            <div>
              ${this.Header()}
              ${this.PageContent(`
                <div class="page-content">
                  <h2>Hello Store</h2>
                  <button onclick="window.app.createStore()">New Store</button>
                </div>
              `)}
            </div>
          `
        },
        // header Components
        Header () {
          return `
            <div class="pure-g">
              <div class="pure-u-2-3">
                <div class="navbar nav-left pure-menu pure-menu-horizontal">
                  <a href="#" onclick="window.app.navigate('dashboard')" class="pure-menu-heading pure-menu-link plug-menu-link">Plug</a>
                  <ul class="pure-menu-list">
                    <li class="pure-menu-item">
                      <a href="#" onclick="window.app.navigate('products')" class="pure-menu-link plug-menu-link">Products</a>
                    </li>
                    <li class="pure-menu-item">
                      <a href="#" onclick="window.app.navigate('orders')" class="pure-menu-link plug-menu-link">Orders</a>
                    </li>
                    <li class="pure-menu-item">
                      <a href="#" onclick="window.app.navigate('store')" class="pure-menu-link plug-menu-link">Store</a>
                    </li>
                  </ul>
                </div>
              </div>
              <div class="pure-u-1-3">
                ${this.StoresDropDown()}
              </div>
            </div>
          `
        },
        StoresDropDown () {
          return `
            <div class="navbar nav-right pure-menu pure-menu-horizontal">
              <ul class="pure-menu-list">
                <li class="pure-menu-item pure-menu-has-children pure-menu-allow-hover">
                  <a href="#" class="pure-menu-link plug-menu-link">${this.currentStore.store.title}</a>
                  <ul class="pure-menu-children">
                    ${this.agent.stores.reduce((html, store) => html += this.StoreDropDownOption(store), '')}
                  </ul>
                </li>
              </ul>
            </div>
          `
        },
        StoreDropDownOption (store) {
          return `
            <li class="pure-menu-item">
              <a onclick="window.app.changeStore(${store.store.id})"href="#" class="pure-menu-link">${store.store.title}</a>
            </li>
          `
        },
        // Product List Page Components
        ProductTable () {
          return `
            <div><h2>Products</h2></div>
            <button class="pure-button pad-bottom" onclick="window.app.navigate('create-product')">Add New</button>
            <div>
              <table class="pure-table pure-table-bordered">
                <thead>
                  <tr>
                      <th><button class="pure-button">&#9776;</button></th>
                      <th>ID</th>
                      <th>Image</th>
                      <th>Name</th>
                      <th>Price</th>
                      <th>Manage</th>
                  </tr>
                </thead>
                <tbody>
                  ${this.agent.catalog.reduce((html, product) => html + this.ProductRow(product.product), '')}
                </tbody>
              </table>            
            </div>
          `
        },
        ProductRow (product) {
          return `
            <tr>
              <td><input type="checkbox" value="" /></td>
              <td>${product.id}</td>
              <td><img width=50px src="${product.images[0]}"></img></td>
              <td>${product.title}</td>
              <td>${this.price(product.price)} </td>
              <td>
                <button onclick="window.app.navigate('product', { 'product': ${this.pass(product)}})" class="pure-button">✏️</button>
                <button class="pure-button" onclick="window.app.deleteProduct(${product.id})">❌</button>
              </td>
            </tr>
          `
        },
        // Create/Edit Product Components
        ProductForm (product={}, title, button) {
          return `
            <form class="pure-form pure-form-stacked">
              <fieldset>
                <legend>${title}</legend>
                <div class="pure-control-group">
                  <label for="product-title">Title</label>
                  <input ${product.title ? `value="${product.title}"` : ''} type="text" id="product-title" placeholder="My Cool Widget" />
                </div>
                <label>Images</label>
                <div id="product-images">
                  ${product.images ? product.images.reduce((html, image) => html + `
                    <img src="${image}"></img>
                  `, ''): ''}
                </div>
                <div class="pure-control-group">
                  <label for="product-image-url">Image Link</label>
                  <input type="text" id="product-image-url" placeholder="https://mysite.com/someimage.jpg" />
                </div>
                <button type="button" onclick="window.app.addImage()" class="pure-button">
                  Add Image
                </button>
                <div class="pure-control-group">
                  <label for="product-description">Description</label>
                  <textarea id="product-description" placeholder="Write about all it's cool features here">${product.description ? product.description : ''}</textarea>
                </div>
                <div class="pure-control-group">
                  <label for="product-price">Price</label>
                  <input ${product.price ? `value="${product.price}"` : ''} type="text" id="product-price" placeholder="$99.99" />
                </div>
                ${button}
              </fieldset>
            </form>
          `
        },
        CreateProductButton () {
          return `
            <button type="button" onclick="window.app.createProduct()" class="pure-button pure-button-primary">Create</button>
          `
        },
        SaveProductButton (id) {
          return `
            <button type="button" onclick="window.app.updateProduct(${id})" class="pure-button pure-button-primary">Save</button>
          `
        },
        // Orders Components
        OrdersTable () {
          return `
          <div>
            <h2>Orders</h2>
            <h4>Coming Soon!</h4>
          </div>          `
        },
        // Generic Components
        PageContent (content) {
          return `
            <div class="pure-g">
              <div class="pure-u-1-12"></div>
              <div class="pure-u-5-6">${content}</div>
              <div class="pure-u-1-12"></div>
            </div>
          `
        },
        // Controller — Lifecycle, Presentation, Interactions
        // Lifecycle
        onLoad: async function () {
          await this.agent.refreshState()
          this.currentStore = this.agent.stores[0]
          this.navigate('products')
        },
        // Router
        navigate (page, params={}) {
          let pageHTML
          switch (page) {
            case "dashboard":
              pageHTML = this.Dashboard()
              break;
            case "products":
              pageHTML = this.ProductsPage()
              break;
            case "create-product":
              pageHTML = this.CreateProductPage()
              break;
            case "product":
              pageHTML = this.EditProductPage(params.product)
              break;
            case "orders":
              pageHTML = this.OrdersPage()
              break;
            case "store":
              pageHTML = this.StorePage()
              break;
          }
          document.getElementById("app").innerHTML = pageHTML
        },
        // Interactions
        async createStore () {
          const title = "Lili's Cool Store"
          await this.agent.createStore(title)
          this.navigate('dashboard')
        },
        async createProduct () {
          const { title, description, price, images } = this.validateProduct()
          await this.agent.createProduct(this.currentStore.id, { title, description, images, price})
          this.navigate('products')
        },
        async updateProduct (id) {
          const { title, description, price, images } = this.validateProduct()
          await this.agent.updateProduct(this.currentStore.id, { id, title, description, images, price})
          this.navigate('products')
        },
        async deleteProduct (id) {
          await this.agent.deleteProduct(this.currentStore.id, id)
          this.navigate('products')
        },
        changeStore (id) {
          store = this.agent.stores.filter(s => s.id == id)[0]
          this.currentStore = store
          this.navigate('dashboard')
        },
        addImage () {
          const url = document.getElementById("product-image-url").value
          const list = document.getElementById("product-images")
          list.innerHTML = list.innerHTML + `
            <img src="${url}"></img>
          `
        },
        // async openLog () {
        //   this.isLogOpen = true
        //   this.navigate('product-detail', { id: this.id })
        // },
        // async closeLog () {
        //   this.isLogOpen = false
        //   this.navigate('product-detail', { id: this.id })
        // }
        // UI Utils
        price (cents) {
          const ones = cents % 10
          return ones > 0 ? '$' + (cents/100) : '$' + (cents/100) + '0'
        },
        pass (item) {
          return JSON
            .stringify(item)
            .replaceAll(`"`,`'`)
        },
        validateProduct () {
          const title = document.getElementById("product-title").value
          const description = document.getElementById("product-description").value
          const price = Number(
            document.getElementById("product-price").value
            .replaceAll(',', '')
            .replaceAll('.', '')
            .replaceAll('$', '')
          )
          const images = []
          document.querySelectorAll('#product-images img').forEach(el => images.push(el.src))
          if (!title) {
            alert('Invalid Title')
            return
          }
          if (!description) {
            alert('Invalid Description')
            return
          }
          if (!price) {
            alert('Invalid Price')
            return
          }
          return { title, description, price, images }
        }
      }
    }

    // Services (Model)
    function PlugAgent () {
      const _mock = true
      const api = _mock ? {} : new UrbitHttpApi.Urbit("")
      api.ship = window.ship;
      return {
        _api:api,
        _scry: async function (path) {
          return this._api.scry({ app: "plug", path })
        },
        _poke: async function (name, payload) {
          return this._api.poke({
            app: "plug",
            mark: "plug-action",
            json: { [name]: payload },
            onError: ()=> alert(`PlugAgent: ${name} action rejected`)
          })
        },
        _mock,
        stores: [],
        catalog: [], //todo: replace with subprop on stores
        createStore: async function (title) {
          if (this._mock) {
            const id = this.stores.reduce((maxId, store) => maxId > store.id ? maxId : store.id, 0) + 1
            this.stores.push({ id, store: {
              id,
              title,
            }})
          } else {
            await this._poke('create-store', { title })
            await this.refreshState()    
          }
        },
        deleteStore: async function (id) {
          if (this._mock) {
          } else {
            await this._poke('delete-store', { id })
            await this.refreshState()    
          }
        },
        createProduct: async function (storeId, { title, description, images, price }) {
          if (this._mock) {
            const id = this.catalog.reduce((maxId, store) => maxId > store.id ? maxId : store.id, 0) + 1
            this.catalog.push({ id, product: { id, title, description, images, price }})
          } else {
            await this._poke('create-product', { 'store-id': storeId, title, description, images, price })
            await this.refreshState()    
          }
        },
        updateProduct: async function (storeId, { id, title, description, images, price }) {
          if (this._mock) {
            this.catalog = this.catalog.filter(item => item.id != id)
            this.catalog.push({ id, product: { id, title, description, images, price }})
          } else {
            await this._poke('update-product', { 'store-id': storeId, id, title, description, images, price })
            await this.refreshState()    
          }
        },
        deleteProduct: async function (storeId, productId) {
          if (this._mock) {
            this.catalog = this.catalog.filter(item => item.id != productId)
          } else {
            await this._poke('update-product', { 'store-id': storeId, 'product-id': productId })
            await this.refreshState()    
          }
        },
        fetchAllProducts: async function () {
          if(this._mock) {
            this.catalog = [
              {
                "product": {
                  "title": "MrCool 12k btu",
                  "images": ["https://random.imagecdn.app/150/150"],
                  "description": "An AC unit with 12k btu cooling power",
                  "id": 1,
                  "price": 69990
                },
                "id": 1
              },{
                "product": {
                  "title": "MrCool 18k btu",
                  "images": ["https://random.imagecdn.app/150/150"],
                  "description": "An AC unit with 18k btu cooling power",
                  "id": 2,
                  "price": 79995
                },
                "id": 2
              }
            ]
          } else {
            const catalog = await this._scry('/products')
            this.catalog = catalog
          }
          console.log(JSON.stringify(this.catalog))
        },
        fetchAllStores: async function () {
          if(this._mock) {
            this.stores = [
              { "store":{ "title":"Lili's Cool Store", "id": 2 },"id": 2},
              { "store":{ "title":"Default Store", "id": 1 }, "id": 1 }
            ]
          } else {
            const stores = await this._scry('/stores')
            this.stores = stores
          }
          console.log(JSON.stringify(this.stores))
        },
        refreshState: async function () {
          await this.fetchAllProducts()    
          await this.fetchAllStores()    
        }
      }
    }

    async function main () {
      setTimeout(() => {
        window.app = App()
        app.onLoad()
      }, 1000)
    }
    main()
  </script>
</html>