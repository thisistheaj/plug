<html>
  <head>
    <script src="https://unpkg.com/@urbit/http-api"></script>
    <script src="/session.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@2.1.0/build/pure-min.css" integrity="sha384-yHIFVG6ClnONEA5yB5DJXfW2/KC173DIQrYoZMEtBvGzmf0PKiGyNEqe9N6BNDBH" crossorigin="anonymous">
    <style type="text/css">
      .navbar {
        background: #666;
      }
      .navbar .plug-menu-link {
        color: #fff;
      }
      .navbar .plug-menu-link:hover {
        background: #444;
      }
      .nav-right {
        /*text-align: right;*/
      }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <div id="app"></div>
  </body>
  <script>
    function App () {
      const agent = PlugAgent()
      return {
        agent,
        currentStore: null,
        // UI Components (View)
        Dashboard () {
          return `
            <div>
              ${this.Header()}
              <div class="page-content">
                <h2>Hello Dashboard</h2>
              </div>
            </div>
            `
        },
        ProductsPage () {
          return `
            <div>
              ${this.Header()}
              <div class="page-content">
                <h2>Hello Products</h2>
              </div>
            </div>
            `
        },
        OrdersPage () {
          return `
            <div>
              ${this.Header()}
              <div class="page-content">
                <h2>Hello Orders</h2>
              </div>
            </div>
          `
        },
        StorePage () {
          return `
            <div>
              ${this.Header()}
              <div class="page-content">
                <h2>Hello Store</h2>
                <button onclick="window.app.createStore()">New Store</button>
              </div>
            </div>
          `
        },
        Header () {
          return `
            <div class="pure-g">
              <div class="pure-u-2-3">
                <div class="navbar nav-left pure-menu pure-menu-horizontal">
                  <a href="#" onclick="window.app.navigate('dashboard')" class="pure-menu-heading pure-menu-link plug-menu-link">Plug</a>
                  <ul class="pure-menu-list">
                    <li class="pure-menu-item">
                      <a href="#" onclick="window.app.navigate('products')" class="pure-menu-link plug-menu-link">Products</a>
                    </li>
                    <li class="pure-menu-item">
                      <a href="#" onclick="window.app.navigate('orders')" class="pure-menu-link plug-menu-link">Orders</a>
                    </li>
                    <li class="pure-menu-item">
                      <a href="#" onclick="window.app.navigate('store')" class="pure-menu-link plug-menu-link">Store</a>
                    </li>
                  </ul>
                </div>
              </div>
              <div class="pure-u-1-3">
                ${this.StoresDropDown()}
              </div>
            </div>
          `
        },
        StoresDropDown () {
          return `
            <div class="navbar nav-right pure-menu pure-menu-horizontal">
              <ul class="pure-menu-list">
                <li class="pure-menu-item pure-menu-has-children pure-menu-allow-hover">
                  <a href="#" class="pure-menu-link plug-menu-link">${this.currentStore.store.title}</a>
                  <ul class="pure-menu-children">
                    ${this.agent.stores.reduce((html, store) => html += this.StoreDropDownOption(store), '')}
                  </ul>
                </li>
              </ul>
            </div>
          `
        },
        StoreDropDownOption (store) {
          return `
            <li class="pure-menu-item">
              <a onclick="window.app.changeStore(${store.store.id})"href="#" class="pure-menu-link">${store.store.title}</a>
            </li>
          `
        },
        // Controller â€” Lifecycle, Presentation, Interactions
        // Lifecycle
        onLoad: async function () {
          await this.agent.refreshState()
          this.currentStore = this.agent.stores[0]
          this.navigate('dashboard')
        },
        // Router
        navigate (page, params={}) {
          let pageHTML
          switch (page) {
            case "dashboard":
              pageHTML = this.Dashboard()
              break;
            case "products":
              pageHTML = this.ProductsPage()
              break;
            case "orders":
              pageHTML = this.OrdersPage()
              break;
            case "store":
              pageHTML = this.StorePage()
              break;
          }
          document.getElementById("app").innerHTML = pageHTML
        },
        // Interactions
        async createStore () {
          const title = "Lili's Cool Store"
          await this.agent.createStore(title)
          this.navigate('dashboard')
        },
        changeStore (id) {
          store = this.agent.stores.filter(s => s.id == id)[0]
          this.currentStore = store
          this.navigate('dashboard')
        }
        // async openLog () {
        //   this.isLogOpen = true
        //   this.navigate('product-detail', { id: this.id })
        // },
        // async closeLog () {
        //   this.isLogOpen = false
        //   this.navigate('product-detail', { id: this.id })
        // }
      }
    }

    // Services (Model)
    function PlugAgent () {
      const _mock = true
      const api = _mock ? {} : new UrbitHttpApi.Urbit("")
      api.ship = window.ship;
      return {
        _api:api,
        _scry: async function (path) {
          return this._api.scry({ app: "plug", path })
        },
        _poke: async function (name, payload) {
          return this._api.poke({
            app: "plug",
            mark: "plug-action",
            json: { [name]: payload },
            onError: ()=> alert(`PlugAgent: ${name} action rejected`)
          })
        },
        _mock,
        stores: [],
        catalog: [], //todo: replace with subprop on stores
        createStore: async function (title) {
          if (this._mock) {
            const id = this.stores.reduce((maxId, store) => maxId > store.id ? maxId : store.id, 0) + 1
            this.stores.push({ id, store: {
              id,
              title,
            }})
          } else {
            await this._poke('create-store', { title })
            await this.refreshState()    
          }
        },
        deleteStore: async function (id) {
          if (this._mock) {
          } else {
            await this._poke('delete-store', { id })
            await this.refreshState()    
          }
        },
        createProduct: async function (storeId, { title, description, images, price }) {
          if (this._mock) {
          } else {
            await this._poke('create-product', { 'store-id': storeId, title, description, images, price })
            await this.refreshState()    
          }
        },
        updateProduct: async function (storeId, { id, title, description, images, price }) {
          if (this._mock) {
          } else {
            await this._poke('update-product', { 'store-id': storeId, id, title, description, images, price })
            await this.refreshState()    
          }
        },
        updateProduct: async function (storeId, productId) {
          if (this._mock) {
          } else {
            await this._poke('update-product', { 'store-id': storeId, 'product-id': productId })
            await this.refreshState()    
          }
        },
        fetchAllProducts: async function () {
          if(this._mock) {
            this.catalog = [
              {
                "product": {
                  "title": "MrCool 12k btu",
                  "images": ["https://image.jpg"],
                  "description": "An AC unit with 12k btu cooling power",
                  "id": 1,
                  "price": 69995
                },
                "id": 1
              },{
                "product": {
                  "title": "MrCool 18k btu",
                  "images": ["https://image.jpg"],
                  "description": "An AC unit with 18k btu cooling power",
                  "id": 2,
                  "price": 79995
                },
                "id": 2
              }
            ]
          } else {
            const catalog = await this._scry('/products')
            this.catalog = catalog
          }
          console.log(JSON.stringify(this.catalog))
        },
        fetchAllStores: async function () {
          if(this._mock) {
            this.stores = [
              { "store":{ "title":"Lili's Cool Store", "id": 2 },"id": 2},
              { "store":{ "title":"Default Store", "id": 1 }, "id": 1 }
            ]
          } else {
            const stores = await this._scry('/stores')
            this.stores = stores
          }
          console.log(JSON.stringify(this.stores))
        },
        refreshState: async function () {
          await this.fetchAllProducts()    
          await this.fetchAllStores()    
        }
      }
    }

    async function main () {
      setTimeout(() => {
        window.app = App()
        app.onLoad()
      }, 1000)
    }
    main()
  </script>
</html>